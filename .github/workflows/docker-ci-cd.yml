name: Docker CI for Microservices

# Chạy workflow khi có push code lên nhánh 'main'
on:
  push:
    branches: [ main ]

jobs:
  build_and_push:
    # Sử dụng máy ảo Ubuntu mới nhất để chạy job
    runs-on: ubuntu-latest

    steps:
    # Bước 1: Lấy mã nguồn từ repository về máy ảo
    - name: Checkout code
      uses: actions/checkout@v3

    # Bước 2: Cài đặt công cụ Docker Buildx (để build hiệu quả hơn)
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # Bước 3: Đăng nhập vào Docker Hub
    # Sử dụng secrets đã cấu hình trong GitHub repository
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.MINHCOPRO2 }} # Thay DOCKERHUB_USERNAME thành MINHCOPRO2
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # Bước 4: Build và đẩy Docker image cho từng service
    # !!! THAY <YOUR_DOCKERHUB_USERNAME> BẰNG TÊN ĐĂNG NHẬP DOCKER HUB CỦA BẠN !!!

    - name: Build and push Auth service image
      uses: docker/build-push-action@v4
      with:
        context: ./auth  # Đường dẫn tới thư mục chứa Dockerfile của service auth
        push: true       # Đẩy image lên Docker Hub sau khi build
        tags: <minhcopro2>/eproject-auth:latest # Tên image trên Docker Hub

    - name: Build and push Product service image
      uses: docker/build-push-action@v4
      with:
        context: ./product
        push: true
        tags: <minhcopro2>/eproject-product:latest

    - name: Build and push Order service image
      uses: docker/build-push-action@v4
      with:
        context: ./order
        push: true
        tags: <minhcopro2>/eproject-order:latest

    - name: Build and push API Gateway service image
      uses: docker/build-push-action@v4
      with:
        context: ./api-gateway
        push: true
        tags: <minhcopro2>/eproject-apigateway:latest